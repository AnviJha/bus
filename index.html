<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Punjab Bus Help Chatbot</title>
  <meta name="color-scheme" content="light dark" />
  <style>
    /* --- CSS Reset & Base --- */
    *, *::before, *::after { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      line-height: 1.4;
      color: #0f172a; /* slate-900 */
      background: #f5f7fb; /* soft */
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    :root {
      --primary: #0b5ed7;     /* deep blue */
      --primary-600: #0a53be;
      --primary-700: #0949a4;
      --bg: #f5f7fb;
      --surface: #ffffff;
      --muted: #eef2ff;
      --text: #0f172a;
      --text-muted: #475569;
      --success: #0ea5e9;
      --danger: #ef4444;
      --shadow: 0 8px 24px rgba(2, 6, 23, 0.06);
      --radius: 16px;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #0b1220;
        --surface: #0f172a;
        --muted: #111827;
        --text: #e5e7eb;
        --text-muted: #9ca3af;
        --shadow: 0 8px 24px rgba(0,0,0,0.35);
      }
      body { background: var(--bg); color: var(--text); }
    }

    /* --- App Layout --- */
    .app {
      display: grid;
      grid-template-rows: auto 1fr auto;
      min-height: 100vh;
      background: var(--bg);
    }

    header.appbar {
      position: sticky; /* sticks at top without overlapping */
      top: 0;
      z-index: 10;
      background: linear-gradient(180deg, var(--primary), var(--primary-600));
      color: #fff;
      box-shadow: var(--shadow);
    }
    .container { max-width: 960px; margin: 0 auto; padding: 12px 16px; }
    .brand { display: flex; align-items: center; gap: 10px; font-weight: 700; }
    .brand .logo { width: 28px; height: 28px; display: grid; place-items: center; background: #fff; color: var(--primary-700); border-radius: 8px; }

    /* --- Chat Area --- */
    main.chat {
      overflow: hidden; /* prevent double scrolling */
    }
    .scroll {
      height: 100%;
      overflow-y: auto;
      overscroll-behavior: contain;
      scroll-behavior: smooth;
      padding: 16px;
    }

    .system-banner {
      display: flex; gap: 8px; align-items: center;
      background: var(--surface);
      border: 1px solid rgba(2, 6, 23, 0.08);
      padding: 10px 12px;
      border-radius: 12px;
      color: var(--text-muted);
      box-shadow: var(--shadow);
      margin: 12px auto;
      max-width: 720px;
    }

    .msg {
      display: grid; gap: 6px; margin: 12px auto; max-width: 720px;
    }
    .bubble {
      position: relative;
      padding: 12px 14px;
      border-radius: 14px;
      background: var(--surface);
      color: var(--text);
      border: 1px solid rgba(2, 6, 23, 0.08);
      box-shadow: var(--shadow);
      word-wrap: break-word; word-break: break-word;
    }
    .bubble.user {
      background: linear-gradient(180deg, var(--primary), var(--primary-600));
      color: #fff;
      justify-self: end;
      border-bottom-right-radius: 6px;
    }
    .bubble.bot { justify-self: start; border-bottom-left-radius: 6px; }
    .meta { font-size: 12px; color: var(--text-muted); }

    /* --- Bus Cards --- */
    .results {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
      margin: 6px 0 0 0;
    }
    @media (min-width: 660px) {
      .results { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    @media (min-width: 920px) {
      .results { grid-template-columns: repeat(3, minmax(0, 1fr)); }
    }
    .bus-card {
      background: var(--surface);
      border: 1px solid rgba(2, 6, 23, 0.08);
      border-radius: 14px;
      padding: 12px;
      box-shadow: var(--shadow);
    }
    .bus-card h4 { margin: 0 0 6px 0; font-size: 16px; color: var(--primary-700); }
    .row { display: flex; gap: 6px; font-size: 14px; color: var(--text-muted); align-items: baseline; }
    .row b { color: var(--text); font-weight: 600; margin-right: 4px; }

    /* --- Input Bar --- */
    .inputbar {
      position: sticky; bottom: 0; z-index: 10;
      background: linear-gradient(180deg, rgba(0,0,0,0), rgba(0,0,0,0.04));
      padding: 8px 12px calc(8px + env(safe-area-inset-bottom));
    }
    .input {
      display: flex; gap: 10px;
      align-items: stretch;
      max-width: 960px;
      margin: 0 auto;
      background: var(--surface);
      border: 1px solid rgba(2, 6, 23, 0.1);
      border-radius: 14px;
      padding: 8px;
      box-shadow: var(--shadow);
    }
    textarea {
      flex: 1;
      resize: none;
      border: none;
      outline: none;
      background: transparent;
      color: inherit;
      font: inherit;
      min-height: 44px;
      max-height: 160px;
      padding: 6px 8px;
    }
    .btn {
      display: inline-flex; align-items: center; justify-content: center; gap: 8px;
      padding: 10px 14px;
      border: none; border-radius: 10px;
      background: var(--primary);
      color: #fff; font-weight: 600; cursor: pointer;
      transition: transform .05s ease, filter .2s ease;
    }
    .btn:disabled { opacity: .6; cursor: not-allowed; }
    .btn:not(:disabled):active { transform: translateY(1px); }

    /* --- Typing --- */
    .typing { color: var(--text-muted); font-style: italic; margin-top: -6px; }
    .dots { display: inline-flex; gap: 2px; margin-left: 6px; }
    .dot { width: 6px; height: 6px; border-radius: 50%; background: currentColor; opacity: .35; animation: blink 1.2s infinite; }
    .dot:nth-child(2) { animation-delay: .2s; }
    .dot:nth-child(3) { animation-delay: .4s; }
    @keyframes blink { 0%, 80%, 100% { opacity: .2 } 40% { opacity: 1 } }

    /* --- Helpers --- */
    .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0; }
  </style>
</head>
<body>
  <div class="app" role="application" aria-label="Punjab Bus Help Chatbot">
    <header class="appbar" role="banner">
      <div class="container">
        <div class="brand" aria-label="App title">
          <span class="logo" aria-hidden="true">üöå</span>
          <span>Punjab Bus Help Chatbot</span>
        </div>
      </div>
    </header>

    <main class="chat" role="main">
      <div id="scroll" class="scroll" tabindex="0" aria-live="polite" aria-atomic="false">
        <div class="system-banner" role="note">
          <strong>Tip:</strong>
          <span>Ask things like ‚ÄúWhere is bus 42 now?‚Äù, ‚ÄúNext bus from Ludhiana to Amritsar‚Äù, or ‚ÄúStatus of route 120‚Äù.</span>
        </div>
        <div id="thread" aria-label="Conversation"></div>
      </div>
    </main>

    <footer class="inputbar" role="contentinfo">
      <div class="input">
        <label class="sr-only" for="msg">Type your message</label>
        <textarea id="msg" placeholder="Ask about buses..." rows="1"></textarea>
        <button id="send" class="btn" type="button" aria-label="Send message">
          <span>Send</span> <span aria-hidden="true">‚Ü©</span>
        </button>
      </div>
    </footer>
  </div>

  <script>
    // ===== Config =====
    const API_URL = "https://bus-new-logs.onrender.com/chat"; // Use your deployed URL in production
    const DEFAULT_USER_ID = 1;

    // ===== DOM =====
    const scrollEl = document.getElementById('scroll');
    const threadEl = document.getElementById('thread');
    const inputEl  = document.getElementById('msg');
    const sendEl   = document.getElementById('send');

    // ===== Utilities =====
    const nowTime = () => new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

    function autoGrowTextarea(el) {
      el.style.height = 'auto';
      el.style.height = Math.min(el.scrollHeight, 160) + 'px';
    }

    function scrollToBottom() {
      // Only force-scroll if the user is near the bottom already
      const nearBottom = scrollEl.scrollHeight - scrollEl.scrollTop - scrollEl.clientHeight < 120;
      if (nearBottom) {
        scrollEl.scrollTop = scrollEl.scrollHeight;
      }
    }

    function addMsg(text, who = 'bot') {
      const wrap = document.createElement('div');
      wrap.className = 'msg';

      const bubble = document.createElement('div');
      bubble.className = `bubble ${who}`;
      bubble.textContent = text;

      const meta = document.createElement('div');
      meta.className = 'meta';
      meta.textContent = (who === 'user' ? 'You' : 'Bot') + ' ¬∑ ' + nowTime();

      wrap.appendChild(bubble);
      wrap.appendChild(meta);
      threadEl.appendChild(wrap);
      scrollToBottom();
      return wrap; // return container to add results below
    }

    function addTyping() {
      const wrap = document.createElement('div');
      wrap.className = 'msg';
      const bubble = document.createElement('div');
      bubble.className = 'bubble bot';
      bubble.innerHTML = `Typing<span class="dots"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span>`;
      wrap.appendChild(bubble);
      threadEl.appendChild(wrap);
      scrollToBottom();
      return wrap;
    }

    function removeEl(el) { if (el && el.remove) el.remove(); }

    function addResults(parentMsgEl, results) {
      if (!Array.isArray(results) || !results.length) return;
      const grid = document.createElement('div');
      grid.className = 'results';
      for (const bus of results) {
        const card = document.createElement('div');
        card.className = 'bus-card';
        const n = bus.bus_number ?? '‚Äî';
        const route = bus.route_name ?? '‚Äî';
        const loc = bus.current_location ?? '‚Äî';
        const status = bus.status ?? '‚Äî';
        card.innerHTML = `
          <h4>Bus ${n}</h4>
          <div class="row"><b>Route:</b><span>${escapeHtml(route)}</span></div>
          <div class="row"><b>Location:</b><span>${escapeHtml(loc)}</span></div>
          <div class="row"><b>Status:</b><span>${escapeHtml(status)}</span></div>
        `;
        grid.appendChild(card);
      }
      parentMsgEl.appendChild(grid);
      scrollToBottom();
    }

    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[s]));
    }

    /** Robust JSON parse: handles raw JSON or fenced code blocks ```json ... ``` */
    function safeParseJson(raw) {
      try { return JSON.parse(raw); } catch (e) {}
      const fence = raw.match(/```(?:json)?\n([\s\S]*?)```/i);
      if (fence) {
        try { return JSON.parse(fence[1]); } catch (e) {}
      }
      // Some servers prefix with "json\n{" or similar
      const trimmed = raw.trim().replace(/^json\s*/i, '');
      try { return JSON.parse(trimmed); } catch (e) {}
      return null;
    }

    async function sendMessage() {
      const text = inputEl.value.trim();
      if (!text) return;

      sendEl.disabled = true;
      const userMsgEl = addMsg(text, 'user');
      inputEl.value = '';
      autoGrowTextarea(inputEl);

      const typingEl = addTyping();

      const controller = new AbortController();
      const timeout = setTimeout(() => controller.abort(), 20000); // 20s timeout

      let payload = { user_id: DEFAULT_USER_ID, message: text };

      try {
        const res = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
          signal: controller.signal,
        });
        const raw = await res.text();
        clearTimeout(timeout);

        const data = safeParseJson(raw);
        removeEl(typingEl);

        if (!data) {
          addMsg('‚ö†Ô∏è Error: could not parse server response.', 'bot');
          return;
        }

        const botReply = data.bot_response || data.response || 'No reply from server.';
        const botMsgEl = addMsg(String(botReply), 'bot');

        if (data.results) addResults(botMsgEl, data.results);

      } catch (err) {
        removeEl(typingEl);
        const note = err.name === 'AbortError' ? 'Request timed out. Please try again.' : 'Network error. Please check connection/server.';
        addMsg('‚ö†Ô∏è ' + note, 'bot');
      } finally {
        sendEl.disabled = false;
        inputEl.focus();
      }
    }

    // ===== Events =====
    sendEl.addEventListener('click', sendMessage);
    inputEl.addEventListener('input', () => autoGrowTextarea(inputEl));

    // Enter to send, Shift+Enter for newline
    inputEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    // On load, focus input and set initial height
    window.addEventListener('load', () => {
      autoGrowTextarea(inputEl);
      inputEl.focus({ preventScroll: true });
    });

    // Keep view pinned near bottom if the user hasn't scrolled up manually
    const observer = new MutationObserver(scrollToBottom);
    observer.observe(threadEl, { childList: true, subtree: true });
  </script>
</body>
</html>
